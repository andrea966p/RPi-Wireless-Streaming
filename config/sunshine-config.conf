# Sunshine Configuration Template for Lab KVM
# Copy this to ~/.config/sunshine/sunshine.conf
# Optimized for stability, low latency, and GPU conflict prevention in lab environment
# Last updated: 2025-11-14

#############################
# GENERAL SETTINGS
#############################

sunshine_name = Lab-KVM-PC
locale = en
min_log_level = info

#############################
# NETWORK SETTINGS
#############################

# Leave external_ip empty for local network only (security)
external_ip =
port = 47989

# UPnP disabled for security in lab environment
upnp = disabled

#############################
# GPU RESILIENCE CONFIGURATION
#############################
# These settings prevent GPU conflicts with other applications
# See config/gpu-conflict-applications.md for details

# Force NVIDIA NVENC encoder (hardware acceleration)
encoder = nvenc

# Use NVIDIA Frame Buffer Capture (fastest method for NVIDIA GPUs)
capture = nvfbc

# NVENC GPU Conflict Prevention Settings:
# nvenc_realtime_hags=0: Lowers GPU scheduler priority from "realtime" to "high"
#   This prevents driver freezes when VRAM is near capacity or other GPU apps are running
#   Critical for preventing system freezes like the one on 2025-11-14
nvenc_realtime_hags = 0

# nvenc_latency_over_power=1: Requests high GPU power mode for stability
#   Prevents GPU throttling that could destabilize streaming quality during high load
nvenc_latency_over_power = 1

# nvenc_preset=1: Fastest encoding preset (P1)
#   Lower latency, minimal GPU time (tradeoff: slightly larger bitrate for same quality)
#   Range: 1-7 (1=fastest/lowest latency, 7=slowest/best compression)
nvenc_preset = 1

# nvenc_vbv_increase=0: Default VBV buffer behavior
#   Can be increased (0-400) to provide buffer headroom for GPU spikes when sharing resources
nvenc_vbv_increase = 0

#############################
# CPU THREADING
#############################

# Use multiple CPU threads to reduce GPU dependency
# Pi 4 Model B can handle the bitrate, so we optimize for PC-side stability
min_threads = 2

#############################
# CODEC SETTINGS
#############################

# HEVC mode: 0=disabled, 1=enabled, 2=forced
hevc_mode = 0

# AV1 mode: 0=disabled, 1=enabled, 2=forced
# Note: Your GPU doesn't support AV1 NVENC (errors show this), keep disabled
av1_mode = 0

#############################
# DISPLAY SETTINGS
#############################

# Output display selection (0 = first display, empty = all displays)
output_name = 0

# Supported framerates - Pi 4 Model B can handle 60+ fps
fps = [30, 60, 120]

# Supported resolutions - Pi 4 Model B (especially 4GB+) can handle 4K
resolutions = [
  {"width": 1920, "height": 1080},
  {"width": 3840, "height": 2160},
  {"width": 1280, "height": 720}
]

# Minimum FPS factor (affects adaptive bitrate)
min_fps_factor = 1

#############################
# AUDIO SETTINGS
#############################

# Number of audio channels
channels = 2

# Audio sink (empty = default)
audio_sink =

# Virtual audio sink name
virtual_sink = sunshine-audio-sink

#############################
# WEB UI SETTINGS
#############################

# Restrict web UI access to LAN only (security)
origin_web_ui_allowed = pc

#############################
# USER SETTINGS
#############################

# Username for authentication
username = andrea

# Password: Set via web UI at https://localhost:47990
# DO NOT store passwords in plaintext in this file

#############################
# SECURITY NOTES
#############################
# - Set a strong password after installation via web UI
# - Keep certificates secure in ~/.config/sunshine/credentials/
# - Restrict web UI access to LAN only (origin_web_ui_allowed = pc)
# - Review firewall rules in ../pc-side/install-sunshine.sh
# - Firewall allows only local network access to ports 47984-47990 and 48010

#############################
# GPU CONFLICT PREVENTION NOTES
#############################
# The configuration above is optimized to prevent GPU conflicts, but it cannot
# completely eliminate them. See config/gpu-conflict-applications.md for:
# - List of applications known to conflict (Electron apps, video editors, etc.)
# - Monitoring GPU usage with nvidia-smi
# - Emergency procedures for GPU conflicts
# - Mitigation strategies
#
# Key incident: 2025-11-14 PC freeze caused by Claude Desktop + Sunshine GPU conflict
# Both competed for NVENC encoder, causing driver crash and system freeze

#############################
# TROUBLESHOOTING
#############################
# - If video stutters: Pi 4 should handle 1080p60 easily, check network first
# - For 4K streaming: Ensure using Ethernet or 5GHz WiFi (WiFi 6 recommended)
# - If audio issues: Check pulseaudio/pipewire configuration
# - If connection fails: Verify firewall allows ports 47984-47990 and 48010
# - For logs: journalctl -u sunshine -f
# - Check status: sudo systemctl status sunshine
# - Restart service: sudo systemctl restart sunshine
# - For GPU conflicts: See recovery/troubleshooting-card.md

#############################
# PERFORMANCE NOTES
#############################
# This configuration prioritizes:
# 1. Stability and reliability (critical for lab use)
# 2. Low latency (< 20ms target)
# 3. GPU conflict prevention
# 4. Compatibility with Pi 4 Model B's excellent performance capabilities
#
# The Pi 4 Model B is significantly more powerful than Pi Zero and can easily
# handle 1080p60 or even 4K30 streaming with proper network infrastructure.
